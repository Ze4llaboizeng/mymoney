<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuromi Money Pro</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&family=Chakra+Petch:wght@400;600&family=VT323&display=swap" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <style>
        /* === MAIN THEME (Kuromi Remastered) === */
        :root {
            --k-bg: #f3e5f5;
            --k-dark: #212121;
            --k-purple: #9c27b0;
            --k-purple-light: #e1bee7;
            --k-pink: #e91e63;
            --k-shadow: rgba(0, 0, 0, 0.15);
        }
        body { 
            background-color: var(--k-bg); 
            background-image: radial-gradient(#e1bee7 1px, transparent 1px);
            background-size: 20px 20px;
            font-family: 'Kanit', sans-serif; 
            padding-bottom: 90px; 
        }

        /* Glass Card Effect */
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 2px solid var(--k-dark);
            border-radius: 20px;
            box-shadow: 6px 6px 0px var(--k-dark);
            transition: transform 0.2s;
            overflow: hidden;
        }
        .glass-card:hover { transform: translateY(-2px); }

        /* Navigation */
        .nav-pills .nav-link { 
            color: var(--k-dark); 
            background: white; 
            border: 2px solid var(--k-dark); 
            margin: 0 3px; 
            border-radius: 50px; 
            font-weight: 600;
        }
        .nav-pills .nav-link.active { 
            background: var(--k-dark); 
            color: var(--k-purple-light); 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transform: scale(1.05); 
        }

        /* Dashboard Header */
        .balance-card {
            background: linear-gradient(135deg, #212121 0%, #4a148c 100%);
            color: white;
            border: none;
            position: relative;
        }
        .balance-card::after {
            content: "‚ò†Ô∏è"; position: absolute; top: 10px; right: 20px; font-size: 3rem; opacity: 0.1;
        }

        /* Transaction List */
        .tx-item {
            background: white;
            border-bottom: 1px solid #eee;
            transition: 0.2s;
        }
        .tx-item:last-child { border-bottom: none; }
        .tx-icon {
            width: 45px; height: 45px;
            background: #f3e5f5; color: var(--k-purple);
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem;
        }

        /* === PIGGY BANK UI (Improved) === */
        .piggy-jar {
            background: #f8bbd0;
            border: 3px solid #880e4f;
            border-radius: 40px;
            padding: 20px;
            position: relative;
            margin-bottom: 30px;
            box-shadow: 0 8px 20px rgba(233, 30, 99, 0.2);
            transition: 0.3s;
        }
        .piggy-jar:active { transform: scale(0.98); }
        .piggy-jar::before, .piggy-jar::after {
            content: ''; position: absolute; top: -15px; width: 40px; height: 40px;
            background: #f8bbd0; border: 3px solid #880e4f; border-radius: 10px; z-index: -1;
        }
        .piggy-jar::before { left: 20px; transform: rotate(-20deg); }
        .piggy-jar::after { right: 20px; transform: rotate(20deg); }
        
        .piggy-nose {
            width: 60px; height: 35px; background: #f48fb1; border: 2px solid #880e4f;
            border-radius: 50%; margin: 0 auto 10px auto; display: flex; justify-content: center; align-items: center; gap: 10px;
            animation: breathe 3s infinite ease-in-out;
        }
        @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .nostril { width: 8px; height: 12px; background: #880e4f; border-radius: 50%; }

        /* === RETRO RECEIPT (Improved) === */
        .retro-wrapper { font-family: 'Chakra Petch', sans-serif; }
        .receipt-paper {
            background-color: #fffdf0;
            padding: 25px 20px;
            position: relative;
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
            margin-top: 10px;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.08'/%3E%3C/svg%3E");
        }
        .jagged-top {
            position: absolute; top: -10px; left: 0; width: 100%; height: 10px;
            background: linear-gradient(135deg, transparent 33%, #fffdf0 33%, #fffdf0 66%, transparent 66%) -5px 0 / 10px 100% repeat-x;
            transform: rotate(180deg);
        }
        .jagged-bottom {
            position: absolute; bottom: -10px; left: 0; width: 100%; height: 10px;
            background: linear-gradient(135deg, transparent 33%, #fffdf0 33%, #fffdf0 66%, transparent 66%) -5px 0 / 10px 100% repeat-x;
        }
        .retro-input {
            font-family: 'VT323', monospace; font-size: 1.3rem; border: none; border-bottom: 1px dotted #888;
            background: transparent; text-align: right; width: 90px; color: #2b2b2b; transition: 0.3s;
        }
        .retro-input:focus { border-bottom: 2px solid var(--k-purple); outline: none; background: rgba(156, 39, 176, 0.05); }
        .vt-font { font-family: 'VT323', monospace; }

        /* === WORTHINESS (New) === */
        .meter-container { height: 20px; background: #ddd; border-radius: 10px; overflow: hidden; position: relative; }
        .meter-fill { height: 100%; transition: width 1s ease-in-out; }
        .day-block { display: inline-block; width: 15px; height: 15px; margin: 2px; border-radius: 3px; background: #bdbdbd; }
        .day-block.active { background: #9c27b0; animation: popIn 0.3s forwards; }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

    </style>
</head>
<body>
    <div class="container py-3" style="max-width: 550px;">
        
        <div class="d-flex justify-content-between align-items-center mb-4 ps-2">
            <div>
                <h4 class="fw-bold m-0" style="color: var(--k-dark);"><i class="bi bi-skull-fill text-purple"></i> Kuromi Pro</h4>
                <small class="text-muted" style="font-size: 0.75rem;">Manage Money like a Boss</small>
            </div>
            <span class="badge bg-dark rounded-pill px-3">v2.5 Remix</span>
        </div>

        <ul class="nav nav-pills nav-fill mb-4" id="pills-tab" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#content-dash"><i class="bi bi-wallet2"></i> ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#content-salary"><i class="bi bi-receipt"></i> ‡∏™‡∏•‡∏¥‡∏õ</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#content-saving"><i class="bi bi-piggy-bank"></i> ‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#content-worth"><i class="bi bi-calculator"></i> ‡∏Ñ‡∏∏‡πâ‡∏°‡πÑ‡∏´‡∏°</button></li>
        </ul>

        <div class="tab-content">
            
            <div class="tab-pane fade show active animate__animated animate__fadeIn" id="content-dash">
                <div class="glass-card balance-card p-4 text-center mb-3">
                    <small class="text-white-50 text-uppercase letter-spacing-2">Net Balance</small>
                    <h1 class="display-3 fw-bold mb-0">‡∏ø{{ "{:,.2f}".format(balance) }}</h1>
                    <div class="d-flex justify-content-center gap-4 mt-3">
                        <div class="text-success bg-white rounded-pill px-3 py-1 shadow-sm"><i class="bi bi-arrow-down"></i> ‡∏£‡∏±‡∏ö {{ "{:,.0f}".format(income) }}</div>
                        <div class="text-danger bg-white rounded-pill px-3 py-1 shadow-sm"><i class="bi bi-arrow-up"></i> ‡∏à‡πà‡∏≤‡∏¢ {{ "{:,.0f}".format(expense) }}</div>
                    </div>
                </div>

                <div class="glass-card p-3 mb-4">
                    <form action="/add" method="POST">
                        <div class="row g-2 mb-2">
                            <div class="col-6">
                                <select name="type" class="form-select border-2 border-dark rounded-pill" id="typeSelect" onchange="toggleCategories()">
                                    <option value="expense">üòà ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å</option>
                                    <option value="income">üòá ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <select name="category" class="form-select border-2 border-dark rounded-pill" id="categorySelect"></select>
                            </div>
                        </div>
                        <div class="input-group mb-2">
                            <span class="input-group-text bg-dark text-white border-dark rounded-start-pill">‡∏ø</span>
                            <input type="number" step="0.01" name="amount" class="form-control border-2 border-dark fw-bold rounded-end-pill" placeholder="0.00" required>
                        </div>
                        <input type="text" name="note" class="form-control border-2 border-dark rounded-pill mb-2" placeholder="üìù ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏£...">
                        <button type="submit" class="btn btn-dark w-100 rounded-pill fw-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
                    </form>
                </div>

                <h6 class="fw-bold ms-2 text-muted mb-2"><i class="bi bi-clock-history"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h6>
                <div class="glass-card p-0" style="max-height: 400px; overflow-y: auto;">
                    {% for t in transactions %}
                    <div class="tx-item p-3 d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center gap-3">
                            <div class="tx-icon shadow-sm">{{ t.icon }}</div>
                            <div style="line-height: 1.2;">
                                <div class="fw-bold">{{ t.note }}</div>
                                <small class="text-muted" style="font-size: 0.75rem;">{{ t.date }} ‚Ä¢ {{ t.category }}</small>
                            </div>
                        </div>
                        <div class="text-end">
                            <div class="{{ 'text-success' if t.type == 'income' else 'text-danger' }} fw-bold fs-5">
                                {{ '+' if t.type == 'income' else '-' }}{{ "{:,.2f}".format(t.amount) }}
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-light text-secondary rounded-circle" onclick='showReceipt("{{ t.note }}", "{{ t.amount }}", "{{ t.date }}", "{{ t.type }}")'><i class="bi bi-receipt"></i></button>
                                <a href="/delete/{{ t.id }}" class="btn btn-sm btn-light text-danger rounded-circle" onclick="return confirmDelete(this.href); return false;"><i class="bi bi-trash"></i></a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="tab-pane fade retro-wrapper" id="content-salary">
                <div class="d-flex justify-content-center gap-2 mb-2">
                    <button class="btn btn-sm btn-dark rounded-pill px-3 shadow" onclick="savePreset()"><i class="bi bi-floppy2-fill"></i> Save Preset</button>
                    <button class="btn btn-sm btn-warning rounded-pill px-3 shadow" onclick="capture('salary-slip-node', 'MySalarySlip')"><i class="bi bi-camera-fill"></i> Capture</button>
                </div>
                
                <div class="receipt-paper" id="salary-slip-node">
                    <div class="jagged-top"></div>
                    <div class="text-center">
                        <div class="retro-brand fs-1 fw-bold">PAYROLL SLIP</div>
                        <div class="small opacity-50 mb-3 vt-font">MONTHLY / 2025</div>
                    </div>

                    <div class="fw-bold text-decoration-underline mb-2">1. INCOME</div>
                    <div class="retro-row"><span>Base Salary</span> <input type="text" id="s_salary" class="retro-input" onblur="calcSalary()" value="{{ salary_preset.get('s_salary', '') }}"></div>
                    <div class="retro-row"><span>Allowance</span> <input type="text" id="s_col" class="retro-input" onblur="calcSalary()" value="{{ salary_preset.get('s_col', '') }}"></div>
                    <div class="retro-row"><span>Level/Pos</span> <input type="text" id="s_level" class="retro-input" onblur="calcSalary()" value="{{ salary_preset.get('s_level', '') }}"></div>
                    <div class="retro-row"><span>Diligence</span> <input type="text" id="s_diligence" class="retro-input" onblur="calcSalary()" value="{{ salary_preset.get('s_diligence', '') }}"></div>
                    <div class="retro-row"><span>Food/Other</span> <input type="text" id="s_food" class="retro-input" onblur="calcSalary()" value="{{ salary_preset.get('s_food', '') }}"></div>

                    <div class="fw-bold text-decoration-underline mb-2 mt-3">2. OVERTIME <span class="small fw-normal opacity-50">(Rate: <span id="ot_rate_display">0.00</span>)</span></div>
                    
                    <div class="retro-row">
                        <span>OT x1.5 (Hr)</span>
                        <div class="d-flex align-items-center">
                            <input type="text" id="ot_15_hr" class="retro-input hrs-input me-2 text-center bg-light" placeholder="0" onblur="calcSalary()" value="{{ salary_preset.get('ot_15_hr', '') }}" style="width:40px;">
                            <span class="amt-text" id="ot_15_amt">0.00</span>
                        </div>
                    </div>
                    <div class="retro-row">
                        <span>OT x1.3 (Hr)</span>
                        <div class="d-flex align-items-center">
                            <input type="text" id="ot_13_hr" class="retro-input hrs-input me-2 text-center bg-light" placeholder="0" onblur="calcSalary()" value="{{ salary_preset.get('ot_13_hr', '') }}" style="width:40px;">
                            <span class="amt-text" id="ot_13_amt">0.00</span>
                        </div>
                    </div>
                    
                    <div class="retro-row fw-bold mt-2 pt-1 border-top border-dark border-dashed">
                        <span>GROSS TOTAL</span>
                        <span class="amt-text" id="gross_income">0.00</span>
                    </div>

                    <div class="fw-bold text-decoration-underline mb-2 mt-3">3. DEDUCTION</div>
                    <div class="retro-row"><span>Tax</span> <input type="text" id="d_tax" class="retro-input text-danger" onblur="calcSalary()" value="{{ salary_preset.get('d_tax', '') }}"></div>
                    <div class="retro-row"><span>SSO</span> <input type="text" id="d_sso" class="retro-input text-danger" onblur="calcSalary()" value="{{ salary_preset.get('d_sso', '') }}"></div>
                    <div class="retro-row"><span>Provident Fund</span> <input type="text" id="d_fund" class="retro-input text-danger" onblur="calcSalary()" value="{{ salary_preset.get('d_fund', '') }}"></div>

                    <div style="border-bottom: 3px double black; margin: 15px 0;"></div>

                    <div class="d-flex justify-content-between align-items-center">
                        <span class="fw-bold fs-4">NET PAY</span>
                        <span class="vt-font fw-bold fs-1" id="net_pay_display">0.00</span>
                    </div>

                    <div class="jagged-bottom"></div>
                </div>
                
                <form action="/add" method="POST" id="salaryForm" class="mt-3">
                    <input type="hidden" name="type" value="income">
                    <input type="hidden" name="category" value="‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô">
                    <input type="hidden" name="note" value="‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏™‡∏∏‡∏ó‡∏ò‡∏¥">
                    <input type="hidden" name="amount" id="final_salary_amount">
                    <button type="button" onclick="submitSalary()" class="btn btn-outline-dark w-100 rounded-pill fw-bold">
                        <i class="bi bi-box-arrow-in-down"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤
                    </button>
                </form>
            </div>

            <div class="tab-pane fade" id="content-saving">
                <div class="d-grid mb-3">
                    <button class="btn btn-dark rounded-pill fw-bold shadow-sm" type="button" data-bs-toggle="collapse" data-bs-target="#addGoalForm">
                        <i class="bi bi-plus-lg"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà
                    </button>
                </div>
                
                <div class="collapse mb-3" id="addGoalForm">
                    <div class="glass-card p-3 bg-white">
                        <form action="/add_saving_goal" method="POST">
                            <input type="text" name="name" class="form-control border-dark mb-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏∞‡∏õ‡∏∏‡∏Å (‡πÄ‡∏ä‡πà‡∏ô iPad)" required>
                            <input type="number" name="target" class="form-control border-dark mb-2" placeholder="‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)" required>
                            <button type="submit" class="btn btn-danger w-100 rounded-pill">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                        </form>
                    </div>
                </div>

                {% for goal in savings %}
                <div class="position-relative animate__animated animate__zoomIn">
                    <div class="piggy-jar" id="piggy-{{ goal.id }}">
                        <a href="/delete_saving/{{ goal.id }}" class="piggy-delete" onclick="return confirmDelete(this.href); return false;">
                            <i class="bi bi-x-lg"></i>
                        </a>

                        <div class="piggy-nose">
                            <div class="nostril"></div><div class="nostril"></div>
                        </div>
                        
                        <div class="text-center mb-2">
                            <h4 class="fw-bold m-0 text-uppercase" style="color: #880e4f; letter-spacing: 1px;">{{ goal.name }}</h4>
                            <div class="badge bg-white text-danger border border-danger mt-1">
                                {{ "{:,.0f}".format(goal.current) }} / {{ "{:,.0f}".format(goal.target) }}
                            </div>
                        </div>
                        
                        {% set pct = (goal.current / goal.target * 100) | round(1) %}
                        <div class="progress border border-2 border-danger" style="height: 25px; border-radius: 15px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-danger" style="width: {{ pct }}%;">{{ pct }}%</div>
                        </div>
                    </div>
                    
                    <div class="glass-card p-2 d-flex justify-content-between align-items-center mb-4 mx-3" style="margin-top: -20px; position: relative; z-index: 2;">
                        <button class="btn btn-sm btn-link text-secondary" onclick="capture('piggy-{{ goal.id }}', 'Saving_{{ goal.name }}')">
                            <i class="bi bi-camera"></i>
                        </button>
                        <form action="/update_saving" method="POST" class="d-flex gap-2">
                            <input type="hidden" name="goal_id" value="{{ goal.id }}">
                            <input type="number" name="amount" class="form-control form-control-sm border-secondary text-center fw-bold" style="width: 80px;" placeholder="Amount" required>
                            <button type="submit" name="action" value="deposit" class="btn btn-sm btn-danger rounded-circle shadow-sm"><i class="bi bi-piggy-bank-fill"></i></button>
                            <button type="submit" name="action" value="withdraw" class="btn btn-sm btn-outline-danger rounded-circle"><i class="bi bi-dash-lg"></i></button>
                        </form>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-5 text-muted opacity-50">
                    <i class="bi bi-piggy-bank display-1"></i>
                    <p class="mt-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏¢<br>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏±‡∏Å‡∏≠‡∏±‡∏ô‡∏™‡∏¥!</p>
                </div>
                {% endfor %}
            </div>

            <div class="tab-pane fade" id="content-worth">
                <div class="glass-card p-4">
                    <h3 class="fw-bold text-center mb-4"><i class="bi bi-stars text-warning"></i> ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡πà‡∏≤</h3>
                    
                    <div class="form-floating mb-2">
                        <input type="text" id="w_name" class="form-control border-dark fw-bold" placeholder="Item">
                        <label>‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏≠‡∏∞‡πÑ‡∏£?</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="number" id="w_price" class="form-control border-dark fw-bold text-center text-primary fs-2" placeholder="Price">
                        <label>‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà (‡∏ö‡∏≤‡∏ó)</label>
                    </div>

                    <div class="accordion mb-3" id="wageAccordion">
                        <div class="accordion-item border-dark rounded overflow-hidden">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed bg-light text-dark small py-2" type="button" data-bs-toggle="collapse" data-bs-target="#wageCollapse">
                                    <i class="bi bi-gear-fill me-2"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ê‡∏≤‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                                </button>
                            </h2>
                            <div id="wageCollapse" class="accordion-collapse collapse" data-bs-parent="#wageAccordion">
                                <div class="accordion-body bg-light">
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <label class="small text-muted">‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á/‡∏ä‡∏°.</label>
                                            <input type="number" id="w_hourly" class="form-control form-control-sm border-secondary text-end" value="{{ settings.hourly_wage }}">
                                        </div>
                                        <div class="col-6">
                                            <label class="small text-muted">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
                                            <input type="number" id="w_monthly" class="form-control form-control-sm border-secondary text-end" value="{{ salary_preset.get('s_salary', 0) }}" readonly>
                                        </div>
                                    </div>
                                    <button class="btn btn-sm btn-dark w-100 mt-2" onclick="saveWage()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button onclick="calcWorth()" class="btn btn-dark w-100 rounded-pill fw-bold py-3 shadow">
                        <i class="bi bi-magic"></i> ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∏‡πâ‡∏°
                    </button>

                    <div id="w_result" class="d-none mt-4 animate__animated animate__fadeInUp">
                        
                        <div class="text-center mb-3">
                            <div class="text-muted small">‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏Å‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏ß‡∏•‡∏≤...</div>
                            <h1 class="display-2 fw-bold text-dark mb-0"><span id="res_hours">0</span> <span class="fs-6 text-muted">‡∏ä‡∏°.</span></h1>
                        </div>

                        <div class="mb-3">
                            <div class="d-flex flex-wrap justify-content-center" id="day_blocks_container"></div>
                            <div class="text-center small text-muted mt-1" id="res_days_text"></div>
                        </div>

                        <div id="res_monthly_box" class="d-none">
                            <label class="small fw-bold text-danger">‡∏Å‡∏¥‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
                            <div class="progress mb-2" style="height: 20px;">
                                <div class="progress-bar bg-danger progress-bar-striped progress-bar-animated" id="res_percent_bar" style="width: 0%"></div>
                            </div>
                            <div class="text-end small text-danger fw-bold"><span id="res_percent">0</span>%</div>
                        </div>

                        <div class="alert alert-dark text-center mt-3 fw-bold border-2" id="w_verdict" style="background: #e1bee7; color: #4a148c; border-color: #9c27b0;">
                            ...
                        </div>
                        
                        <button class="btn btn-outline-secondary w-100 rounded-pill btn-sm" onclick="capture('content-worth', 'Worthiness_Check')">
                             üì∏ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                        </button>
                    </div>
                </div>
            </div>

        </div> 
    </div>

    <div class="modal fade" id="receiptModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 bg-transparent">
                <div id="miniReceiptNode" class="mx-auto bg-white p-3 shadow-lg" style="width: 320px; font-family: 'VT323', monospace; position: relative;">
                    <div style="position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 100px; height: 30px; background: rgba(255,255,255,0.4); border: 1px solid rgba(0,0,0,0.1); box-shadow: 0 2px 5px rgba(0,0,0,0.1);"></div>
                    
                    <div class="text-center border-bottom border-dark border-2 pb-2 mb-2">
                        <i class="bi bi-skull-fill"></i> KUROMI STORE <i class="bi bi-skull-fill"></i>
                    </div>
                    <div class="d-flex justify-content-between mb-2 small">
                        <span>DT: <span id="r_date"></span></span>
                        <span>POS: #001</span>
                    </div>
                    <table class="w-100 fs-5 mb-3">
                        <tr style="border-bottom: 1px dashed black;">
                            <td class="text-start">ITEM</td>
                            <td class="text-end">THB</td>
                        </tr>
                        <tr>
                            <td class="text-start pt-2" id="r_note">...</td>
                            <td class="text-end pt-2" id="r_amount">...</td>
                        </tr>
                        <tr>
                            <td class="text-start small text-muted" id="r_type">...</td>
                            <td></td>
                        </tr>
                    </table>
                    <div class="border-top border-dark border-2 pt-2 mt-2 d-flex justify-content-between fs-4 fw-bold">
                        <span>TOTAL</span>
                        <span id="r_total">...</span>
                    </div>
                    <div class="text-center mt-3 small opacity-50">THANK YOU COME AGAIN</div>
                    <div class="mt-2" style="height: 40px; background: repeating-linear-gradient(to right, #000 0px, #000 2px, transparent 2px, transparent 5px);"></div>
                </div>
                <div class="text-center mt-3">
                    <button class="btn btn-light fw-bold rounded-pill px-4 shadow" onclick="capture('miniReceiptNode', 'MiniSlip')">
                        <i class="bi bi-download"></i> Save Image
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // === SweetAlert Confirmation ===
        function confirmDelete(url) {
            Swal.fire({
                title: '‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ô‡∏∞?',
                text: "‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏≠‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏°‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ô‡∏∞!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: '‡∏•‡∏ö‡πÄ‡∏•‡∏¢!',
                cancelButtonText: '‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = url;
                }
            })
            return false; 
        }

        // === Capture ===
        function capture(id, filename) {
            const node = document.getElementById(id);
            html2canvas(node, { scale: 2, backgroundColor: null }).then(canvas => {
                const link = document.createElement('a');
                link.download = filename + '_' + Date.now() + '.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        }
        
        // === Receipt Modal ===
        const receiptModal = new bootstrap.Modal(document.getElementById('receiptModal'));
        function showReceipt(note, amount, date, type) {
            document.getElementById('r_note').innerText = note;
            document.getElementById('r_amount').innerText = parseFloat(amount).toFixed(2);
            document.getElementById('r_total').innerText = parseFloat(amount).toFixed(2);
            document.getElementById('r_date').innerText = date;
            document.getElementById('r_type').innerText = type.toUpperCase();
            document.getElementById('r_amount').style.color = type === 'income' ? 'green' : 'red';
            receiptModal.show();
        }

        // === Categories ===
        const cats = { expense: ["‡∏Ç‡∏≠‡∏á‡∏Å‡∏¥‡∏ô", "‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á", "‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á", "‡∏ö‡∏¥‡∏•", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"], income: ["‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", "‡πÇ‡∏ö‡∏ô‡∏±‡∏™", "‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"] };
        function toggleCategories() {
            const type = document.getElementById("typeSelect").value;
            const sel = document.getElementById("categorySelect");
            sel.innerHTML = "";
            cats[type].forEach(c => {
                let opt = document.createElement("option");
                opt.innerText = c; opt.value = c; sel.appendChild(opt);
            });
        }
        toggleCategories();

        // === Salary Logic ===
        function safeEval(str) { try { return new Function('return ' + str)() || 0; } catch { return 0; } }
        function getVal(id) {
            let el = document.getElementById(id); if(!el) return 0;
            let valStr = el.value;
            if(/[+\-*/]/.test(valStr)) { let res = safeEval(valStr); el.value = res; return res; }
            return parseFloat(valStr) || 0;
        }
        function setTxt(id, val) { 
            let el = document.getElementById(id);
            if(el) el.innerText = val.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}); 
        }

        function calcSalary() {
            let salary = getVal('s_salary'); let col = getVal('s_col'); let level = getVal('s_level');
            let diligence = getVal('s_diligence'); let food = getVal('s_food'); 
            let baseForOt = salary + col + level;
            let rate = baseForOt > 0 ? (baseForOt / 30) / 8 : 0;
            setTxt('ot_rate_display', rate);
            
            let h15 = getVal('ot_15_hr'); let h13 = getVal('ot_13_hr');
            let amt15 = rate * 1.5 * h15; let amt13 = rate * 1.3 * h13;
            setTxt('ot_15_amt', amt15); setTxt('ot_13_amt', amt13);
            
            let gross = baseForOt + diligence + food + amt15 + amt13;
            setTxt('gross_income', gross);
            
            let totalDeduct = getVal('d_tax') + getVal('d_sso') + getVal('d_fund');
            let net = gross - totalDeduct;
            setTxt('net_pay_display', net);
            document.getElementById('final_salary_amount').value = net;
        }
        function submitSalary() { 
            calcSalary(); 
            Swal.fire({
                title: '‡∏¢‡∏≠‡∏î‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏´‡∏°?',
                text: "‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤ Dashboard ‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏∞",
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '‡∏à‡∏±‡∏î‡πÑ‡∏õ!'
            }).then((result) => {
                if(result.isConfirmed) document.getElementById('salaryForm').submit();
            });
        }
        function savePreset() {
            const preset = {}; document.querySelectorAll('.retro-input').forEach(input => preset[input.id] = input.value);
            fetch('/save_salary_preset', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(preset) })
            .then(() => Swal.fire('Saved!', '‡∏à‡∏≥‡∏Ñ‡πà‡∏≤ Payroll ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success'));
        }
        
        // === Worthiness Logic (Updated) ===
        function saveWage() {
            const formData = new FormData();
            formData.append('hourly_wage', document.getElementById('w_hourly').value);
            fetch('/update_settings', { method: 'POST', body: formData })
            .then(() => Swal.fire('Saved', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á‡πÅ‡∏•‡πâ‡∏ß', 'success'));
        }

        function calcWorth() {
            let price = parseFloat(document.getElementById('w_price').value) || 0;
            let hourly = parseFloat(document.getElementById('w_hourly').value) || 0;
            let monthly = parseFloat(document.getElementById('w_monthly').value) || 0;

            if(hourly <= 0) { Swal.fire('‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏Å‡πà‡∏≠‡∏ô', '‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á‡∏ï‡πà‡∏≠‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏¥ (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà 0 ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤)', 'warning'); return; }
            if(price <= 0) { Swal.fire('‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà?', '‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞', 'warning'); return; }

            // 1. Calculate Hours & Days
            let hoursNeeded = price / hourly;
            document.getElementById('res_hours').innerText = hoursNeeded.toFixed(1);
            
            // Visual Blocks (1 block = 1 day or 8 hours)
            let days = hoursNeeded / 8;
            let container = document.getElementById('day_blocks_container');
            container.innerHTML = '';
            
            let blockCount = Math.ceil(days);
            if(blockCount > 30) blockCount = 30; // Max limit visually

            for(let i=0; i<blockCount; i++) {
                let div = document.createElement('div');
                div.className = 'day-block';
                div.style.animationDelay = (i * 0.05) + 's';
                setTimeout(() => div.classList.add('active'), 100);
                container.appendChild(div);
            }
            document.getElementById('res_days_text').innerText = `‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ${days.toFixed(1)} ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ${blockCount >= 30 ? '(‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô!)' : ''}`;

            // 2. Monthly Impact
            let monthBox = document.getElementById('res_monthly_box');
            let verdict = document.getElementById('w_verdict');
            document.getElementById('w_result').classList.remove('d-none');

            if (price >= 1000 && monthly > 0) {
                let pct = (price / monthly) * 100;
                document.getElementById('res_percent').innerText = pct.toFixed(1);
                document.getElementById('res_percent_bar').style.width = Math.min(pct, 100) + '%';
                monthBox.classList.remove('d-none');
                
                if(pct > 50) verdict.innerText = "üò± ‡∏ï‡∏≤‡∏¢‡∏™‡∏á‡∏ö‡∏®‡∏û‡∏™‡∏µ‡∏ä‡∏°‡∏û‡∏π (‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô!)";
                else if(pct > 20) verdict.innerText = "ü§î ‡∏Ñ‡∏¥‡∏î‡∏´‡∏ô‡∏±‡∏Å‡πÜ ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏∞‡πÄ‡∏ó‡∏∑‡∏≠‡∏ô";
                else verdict.innerText = "üí∏ ‡∏ã‡∏∑‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç ‡∏à‡∏±‡∏î‡πÑ‡∏õ!";
            } else {
                monthBox.classList.add('d-none');
                if(hoursNeeded < 4) verdict.innerText = "üòé ‡∏ä‡∏¥‡∏•‡πÜ ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏õ‡πä‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏Ñ‡∏∑‡∏ô";
                else verdict.innerText = "‚úåÔ∏è ‡πÅ‡∏•‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏´‡∏¢‡∏≤‡∏î‡πÄ‡∏´‡∏á‡∏∑‡πà‡∏≠";
            }
        }

        // Init
        calcSalary();
    </script>
</body>
</html>
